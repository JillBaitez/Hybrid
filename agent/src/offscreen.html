<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTOS Offscreen Document</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        #iframe-container {
            display: none; /* Hidden - text-only iframes */
            position: absolute;
            top: -1000px;
            left: -1000px;
            width: 0;
            height: 0;
            overflow: hidden;
        }
        
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
        }
        
        .status.ready {
            background: rgba(34, 197, 94, 0.8);
        }
        
        .status.error {
            background: rgba(239, 68, 68, 0.8);
        }
    </style>
</head>
<body>
    <div id="iframe-container">
        <!-- Text-only provider iframes will be injected here -->
    </div>
    
    <div id="status" class="status">Initializing...</div>
    
    <script type="module">
        /**
         * Offscreen Document Entry Point
         * Initializes the OffscreenDocument singleton
         */
        
        // Import the OffscreenDocument class
        import { OffscreenDocument } from './os.js';
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            const statusEl = document.getElementById('status');
            
            try {
                statusEl.textContent = 'Creating offscreen document...';
                
                // Create and initialize the offscreen document
                const offscreen = await OffscreenDocument.create();
                
                if (offscreen.isReady) {
                    statusEl.textContent = 'Ready';
                    statusEl.classList.add('ready');
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Offscreen document not ready');
                }
                
            } catch (error) {
                console.error('Failed to initialize offscreen document:', error);
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.classList.add('error');
            }
        });
        
        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Offscreen document error:', event.error);
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = `Error: ${event.error?.message || 'Unknown error'}`;
                statusEl.classList.add('error');
                statusEl.style.display = 'block';
            }
        });
        
        // Message handler for iframe communication
        window.addEventListener('message', (event) => {
            // Handle messages from provider iframes
            if (event.data?.type === 'TOKEN_RESPONSE') {
                console.log('Token response received from iframe:', event.data.provider);
            } else if (event.data?.type === 'AUTH_COMPLETE') {
                console.log('Authentication complete for iframe:', event.data.provider);
            }
        });
        
        // Debug helpers (available in console)
        window.HTOS_DEBUG = {
            getOffscreen: () => OffscreenDocument.getInstance(),
            getIframes: () => {
                const offscreen = OffscreenDocument.getInstance();
                return Array.from(document.querySelectorAll('iframe')).map(iframe => ({
                    provider: iframe.getAttribute('data-provider'),
                    src: iframe.src,
                    loaded: iframe.contentDocument !== null
                }));
            },
            extractToken: (provider) => {
                const offscreen = OffscreenDocument.getInstance();
                return offscreen.extractToken(provider);
            }
        };
    </script>
</body>
</html>